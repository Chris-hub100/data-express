{% extends "base.html" %}

{% block content %}

<!-- 1. BACK NAVIGATION -->
<div class="mb-3">
    <!-- We use 'is_voucher' passed from Python to decide where to go back -->
    <a href="{% if is_voucher %}/vouchers{% else %}/shop{% endif %}" class="text-decoration-none text-muted fw-bold" style="font-size: 0.9rem;">
        <i class="bi bi-arrow-left"></i> Back to Menu
    </a>
</div>

<div class="container mt-4">
    
    <h3 class="fw-bold mb-3">Buy {{ network_name }} Bundles</h3>
    <p class="text-muted small mb-4">Tap a package below to start</p>
    
    <form id="paymentForm">
        
        <!-- 2. SCROLLING CARDS -->
        <div class="scrolling-wrapper mb-4">
            {% for bundle in bundles %}
            <div class="card bundle-card text-center p-3" 
                 onclick="selectBundle(this, '{{ bundle.price }}', '{{ bundle.name }}')">
                
                <div class="mb-2">
                    <span class="network-badge">{{ network_name }}</span>
                </div>
                
                <h5 class="fw-bold mb-1">{{ bundle.name }}</h5>
                <div class="text-primary fw-bold fs-5">GHS {{ bundle.price }}</div>
            </div>
            {% endfor %}
        </div>

        <input type="hidden" id="selected_price" value="">
        <input type="hidden" id="selected_name" value="">

        <!-- 3. CHECKOUT FORM (Hidden initially) -->
        <div id="checkoutSection" class="card p-4 shadow-sm border-0 mb-5 d-none animate__fadeIn">
            
            <h5 class="fw-bold mb-3 text-primary">Finish Order</h5>

            <div class="mb-4">
                <label class="form-label fw-bold">
                    {% if input_type == 'id' %}
                        Enter Player ID / User ID
                    {% elif input_type == 'email' %}
                        Enter Delivery Email Address ðŸ“§
                    {% elif is_voucher %}
                        Enter WhatsApp Number (for code)
                    {% else %}
                        Enter MoMo Number (to receive data)
                    {% endif %}
                </label>

                <!-- Dynamic Input Type -->
                <input type="{% if input_type == 'email' %}email{% else %}text{% endif %}" 
                       id="customer_input" 
                       class="form-control form-control-lg bg-light" 
                       placeholder="{% if input_type == 'id' %}e.g. 674839201{% elif input_type == 'email' %}name@example.com{% else %}05xxxxxxxx{% endif %}" 
                       required>
                
                <!-- Helpers -->
                {% if input_type == 'id' %}
                <div class="form-text text-primary small mt-1">
                    <i class="bi bi-info-circle"></i> Found in your game profile
                </div>
                {% endif %}
                
                {% if input_type == 'email' %}
                <div class="form-text text-muted small mt-1">
                    <i class="bi bi-lock-fill"></i> We will send the digital code to this inbox.
                </div>
                {% endif %}
            </div>

            <div class="d-grid">
                <button type="submit" id="payBtn" class="btn btn-warning btn-lg fw-bold shadow" onclick="payWithPaystack(event)">
                    Confirm Payment
                </button>
            </div>
        </div>

    </form>
</div>

<!-- JAVASCRIPT LOGIC -->
<script>
    // âš ï¸ Replace this with your LIVE Public Key from Paystack Dashboard
    const publicKey = "pk_test_4d5f7d2417619f29633bc5004e1dafdbf3629a3f"; 
    
    // Pass variables safely to JS (Using quotes prevents VS Code errors)
    const inputType = "{{ input_type }}"; 
    const isVoucher = "{{ is_voucher }}" === "True"; // This turns the string "True" into a real boolean

    function selectBundle(cardElement, price, name) {
        let cards = document.querySelectorAll('.bundle-card');
        cards.forEach(c => c.classList.remove('active'));
        cardElement.classList.add('active');

        document.getElementById('selected_price').value = price;
        document.getElementById('selected_name').value = name;

        let section = document.getElementById('checkoutSection');
        let btn = document.getElementById('payBtn');
        
        section.classList.remove('d-none');
        btn.innerHTML = `Pay GHS ${price}`; 

        section.scrollIntoView({behavior: "smooth", block: "start"});
        setTimeout(() => {
            document.getElementById("customer_input").focus();
        }, 500);
    }

    function payWithPaystack(e) {
        e.preventDefault();
        
        let customerData = document.getElementById("customer_input").value;
        let amount = document.getElementById("selected_price").value;
        let bundleName = document.getElementById("selected_name").value;

        if (!amount) { alert("Please select a package"); return; }
        if (customerData === "") { alert("Please fill in the required info"); return; }

        // Dynamic Label for Paystack
        let fieldLabel = "Mobile Number";
        if (inputType === 'id') { fieldLabel = "Player ID"; }
        else if (inputType === 'email') { fieldLabel = "Email Address"; }
        else if (isVoucher) { fieldLabel = "WhatsApp Number"; }

        let handler = PaystackPop.setup({
            key: publicKey,
            email: "customer@dataexpress.store",
            amount: amount * 100,
            currency: "GHS",
            metadata: {
                custom_fields: [
                    { display_name: fieldLabel, variable_name: "recipient_info", value: customerData },
                    { display_name: "Item Purchased", variable_name: "bundle", value: bundleName }
                ]
            },
            callback: function(response) {
                verifyTransaction(response.reference, customerData, bundleName, fieldLabel);
            }
        });

        handler.openIframe();
    }

    function verifyTransaction(ref, data, bundle, label) {
        document.getElementById("payBtn").innerText = "Verifying...";
         
         fetch("/verify_payment", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ reference: ref, name: "Customer", phone: data, bundle: bundle })
        })
        .then(res => res.json())
        .then(resData => {
            if(resData.status === "success") {
                window.location.href = `/success?recipient=${encodeURIComponent(data)}&network=${encodeURIComponent(bundle)}&label=${encodeURIComponent(label)}`;
            } else {
                alert("Verification Failed.");
            }
        });
    }
</script>

<style>
    .animate__fadeIn {
        animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

{% endblock %}