{% extends "base.html" %}

{% block content %}
<div class="mb-3">
    <a href="/shop" class="text-decoration-none text-muted fw-bold" style="font-size: 0.9rem;">
        <i class="bi bi-arrow-left"></i> Back to Networks
    </a>
</div>
<div class="container mt-4">
    
    <h3 class="fw-bold mb-3">Buy {{ network_name }} Bundles</h3>
    <p class="text-muted small mb-4">Tap a package below to start</p>
    
    <form id="paymentForm">
        
        <div class="scrolling-wrapper mb-4">
            {% for bundle in bundles %}
            <div class="card bundle-card text-center p-3" 
                 onclick="selectBundle(this, '{{ bundle.price }}', '{{ bundle.name }}')">
                
                <div class="mb-2">
                    <span class="network-badge">{{ network_name }}</span>
                </div>
                
                <h5 class="fw-bold mb-1">{{ bundle.name }}</h5>
                <div class="text-primary fw-bold fs-5">GHS {{ bundle.price }}</div>
            </div>
            {% endfor %}
        </div>

        <input type="hidden" id="selected_price" value="">
        <input type="hidden" id="selected_name" value="">

        <div id="checkoutSection" class="card p-4 shadow-sm border-0 mb-5 d-none animate__fadeIn">
            
            <h5 class="fw-bold mb-3 text-primary">Finish Order</h5>

            <div class="mb-4">
                <label class="form-label fw-bold">Enter Recipient Number</label>
                <input type="tel" id="phone" class="form-control form-control-lg bg-light" placeholder="05xxxxxxxx" required>
            </div>

            <div class="d-grid">
                <button type="submit" id="payBtn" class="btn btn-warning btn-lg fw-bold shadow" onclick="payWithPaystack(event)">
                    Confirm Payment
                </button>
            </div>
        </div>

    </form>
</div>

<script>
    const publicKey = "pk_test_YOUR_ACTUAL_KEY_HERE"; 

    function selectBundle(cardElement, price, name) {
        // 1. Highlight the card visually
        let cards = document.querySelectorAll('.bundle-card');
        cards.forEach(c => c.classList.remove('active'));
        cardElement.classList.add('active');

        // 2. Store the data
        document.getElementById('selected_price').value = price;
        document.getElementById('selected_name').value = name;

        // 3. REVEAL THE CHECKOUT SECTION
        let section = document.getElementById('checkoutSection');
        let btn = document.getElementById('payBtn');
        
        // Remove the 'd-none' class to show it
        section.classList.remove('d-none');
        
        // Update button text
        btn.innerHTML = `Pay GHS ${price} for ${name}`;

        // 4. SMOOTH SCROLL (UX Magic)
        // Automatically scroll down so the user sees the input
        section.scrollIntoView({behavior: "smooth", block: "start"});
        
        // Focus the cursor on the phone box so they can type immediately
        // (Wait 500ms for the scroll to finish)
        setTimeout(() => {
            document.getElementById("phone").focus();
        }, 500);
    }

    function payWithPaystack(e) {
        e.preventDefault();
        
        let phone = document.getElementById("phone").value;
        let amount = document.getElementById("selected_price").value;
        let bundleName = document.getElementById("selected_name").value;

        if (!amount) { alert("Please select a bundle"); return; }
        if (phone.length < 10) { alert("Enter a valid phone number"); return; }

        let handler = PaystackPop.setup({
            key: publicKey,
            email: "customer@dataexpress.store",
            amount: amount * 100,
            currency: "GHS",
            metadata: {
                custom_fields: [
                    { display_name: "Phone", variable_name: "phone", value: phone },
                    { display_name: "Bundle", variable_name: "bundle", value: bundleName }
                ]
            },
            callback: function(response) {
                verifyTransaction(response.reference, "Customer", phone, bundleName);
            }
        });

        handler.openIframe();
    }

    function verifyTransaction(ref, name, phone, bundle) {
        document.getElementById("payBtn").innerText = "Verifying...";
         fetch("/verify_payment", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ reference: ref, name: name, phone: phone, bundle: bundle })
        })
        .then(res => res.json())
        .then(data => {
            if(data.status === "success") {
                window.location.href = `/success?phone=${phone}&network=${bundle}`;
            } else {
                alert("Verification Failed.");
            }
        });
    }
</script>

<style>
    .animate__fadeIn {
        animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

{% endblock %}